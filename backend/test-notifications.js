const { MongoClient, ObjectId } = require('mongodb');
const dotenv = require('dotenv');
dotenv.config();

const uri = process.env.MONGODB_URI;

async function testNotifications() {
    const client = new MongoClient(uri);
    try {
        await client.connect();
        const db = client.db();

        console.log('--- Testing Notification Trigger ---');

        // 1. Find an admin
        const admin = await db.collection('users').findOne({ role: 'admin' });
        if (!admin) {
            console.log('No admin found to test with.');
            return;
        }

        console.log(`Found admin: ${admin.email} (${admin._id})`);

        // 2. Insert a test notification
        const notification = {
            recipient: admin._id,
            hostel_id: admin.hostel_id,
            title: 'Test Notification',
            message: 'This is a test notification generated by the verification script.',
            type: 'success',
            isRead: false,
            createdAt: new Date(),
            updatedAt: new Date()
        };

        const result = await db.collection('notifications').insertOne(notification);
        console.log(`Inserted test notification: ${result.insertedId}`);

        // 3. Insert a registration alert simulation
        const regAlert = {
            recipient: admin._id,
            hostel_id: admin.hostel_id,
            title: 'New Boarder Registration',
            message: 'John Doe has registered and is pending approval.',
            type: 'info',
            isRead: false,
            createdAt: new Date(),
            updatedAt: new Date()
        };

        await db.collection('notifications').insertOne(regAlert);
        console.log('Inserted registration alert simulation.');

        console.log('\nVerification complete. Please check the notification bell in the frontend.');

    } catch (err) {
        console.error('Verification failed:', err.message);
    } finally {
        await client.close();
    }
}

testNotifications();
